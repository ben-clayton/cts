{"version":3,"sources":["../../../../src/webgpu/util/texture/subresource.ts"],"names":["assert","kAllTextureFormatInfo","align","endOfRange","r","begin","count","end","rangeAsIterator","i","SubresourceRange","constructor","subresources","mipRange","layerRange","each","level","layer","mipLevels","layers","physicalMipSize","size","format","dimension","Math","max","width","height","virtualWidthAtLevel","virtualHeightAtLevel","physicalWidthAtLevel","blockWidth","physicalHeightAtLevel","blockHeight","depthOrArrayLayers"],"mappings":"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","sourcesContent":["import { assert } from '../../../common/framework/util/util.js';\nimport { kAllTextureFormatInfo } from '../../capability_info.js';\nimport { align } from '../../util/math.js';\n\nexport interface BeginCountRange {\n  begin: number;\n  count: number;\n}\n\nexport interface BeginEndRange {\n  begin: number;\n  end: number;\n}\n\nfunction endOfRange(r: BeginEndRange | BeginCountRange): number {\n  return 'count' in r ? r.begin + r.count : r.end;\n}\n\nfunction* rangeAsIterator(r: BeginEndRange | BeginCountRange): Generator<number> {\n  for (let i = r.begin; i < endOfRange(r); ++i) {\n    yield i;\n  }\n}\n\nexport class SubresourceRange {\n  readonly mipRange: BeginEndRange;\n  readonly layerRange: BeginEndRange;\n\n  constructor(subresources: {\n    mipRange: BeginEndRange | BeginCountRange;\n    layerRange: BeginEndRange | BeginCountRange;\n  }) {\n    this.mipRange = {\n      begin: subresources.mipRange.begin,\n      end: endOfRange(subresources.mipRange),\n    };\n    this.layerRange = {\n      begin: subresources.layerRange.begin,\n      end: endOfRange(subresources.layerRange),\n    };\n  }\n\n  *each(): Generator<{ level: number; layer: number }> {\n    for (let level = this.mipRange.begin; level < this.mipRange.end; ++level) {\n      for (let layer = this.layerRange.begin; layer < this.layerRange.end; ++layer) {\n        yield { level, layer };\n      }\n    }\n  }\n\n  *mipLevels(): Generator<{ level: number; layers: Generator<number> }> {\n    for (let level = this.mipRange.begin; level < this.mipRange.end; ++level) {\n      yield {\n        level,\n        layers: rangeAsIterator(this.layerRange),\n      };\n    }\n  }\n}\n\n// TODO(jiawei.shao@intel.com): support 1D and 3D textures\nexport function physicalMipSize(\n  size: Required<GPUExtent3DDict>,\n  format: GPUTextureFormat,\n  dimension: GPUTextureDimension,\n  level: number\n): Required<GPUExtent3DDict> {\n  assert(dimension === '2d');\n  assert(Math.max(size.width, size.height) >> level > 0);\n\n  const virtualWidthAtLevel = Math.max(size.width >> level, 1);\n  const virtualHeightAtLevel = Math.max(size.height >> level, 1);\n  const physicalWidthAtLevel = align(virtualWidthAtLevel, kAllTextureFormatInfo[format].blockWidth);\n  const physicalHeightAtLevel = align(\n    virtualHeightAtLevel,\n    kAllTextureFormatInfo[format].blockHeight\n  );\n  return {\n    width: physicalWidthAtLevel,\n    height: physicalHeightAtLevel,\n    depthOrArrayLayers: size.depthOrArrayLayers,\n  };\n}\n"],"file":"subresource.js"}